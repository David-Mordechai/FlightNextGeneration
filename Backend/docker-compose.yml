services:
  postgis:
    image: postgis/postgis:16-3.4
    container_name: flight_postgis
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    volumes:
      - postgres_data:/var/lib/postgresql/data

  aspire-dashboard:
    image: mcr.microsoft.com/dotnet/nightly/aspire-dashboard:latest
    container_name: flight_aspire_dashboard
    ports:
      - "18888:18888"
      - "4317:4317"
      - "4318:4318"
    environment:
      - DOTNET_DASHBOARD_UNSECURED_ALLOW_ANONYMOUS=true
      - DOTNET_DASHBOARD_OTLP_ENDPOINT_URL=http://0.0.0.0:4317
      - DOTNET_DASHBOARD_OTLP_HTTP_ENDPOINT_URL=http://0.0.0.0:4318

  bff.service:
    image: ${DOCKER_REGISTRY-}bffservice
    build:
      context: .
      dockerfile: Bff.Service/Dockerfile
    depends_on:
      - c4ientities
      - mcpserver.flightcontrol
    ports:
      - "5135:8080"
    environment:
      - OllamaUrl=${OLLAMA_URL:-http://host.docker.internal:11434}
      - AIProvider=${AI_PROVIDER}
      - OllamaModel=${OLLAMA_MODEL}
      - OpenAIModelName=${OPENAI_MODEL_NAME}
      - OpenAIKey=${OPENAI_KEY}
      - GoogleGeminiModel=${GOOGLE_GEMINI_MODEL}
      - GoogleGeminiKey=${GOOGLE_GEMINI_KEY}
      - McpServerUrl=http://mcpserver.flightcontrol:8080;http://mcpserver.missioncontrol:8080
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://aspire-dashboard:4317
      - OTEL_SERVICE_NAME=flight-bff
    extra_hosts:
      - "host.docker.internal:host-gateway"

  c4ientities:
    image: ${DOCKER_REGISTRY-}c4ientities
    build:
      context: .
      dockerfile: C4IEntities/Dockerfile
    depends_on:
      - postgis
      - aspire-dashboard
    ports:
      - "5293:8080"
    environment:
      - ConnectionStrings__DefaultConnection=Host=postgis;Database=${POSTGRES_DB};Username=${POSTGRES_USER};Password=${POSTGRES_PASSWORD}
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://aspire-dashboard:4317
      - OTEL_SERVICE_NAME=flight-c4i

  mcpserver.flightcontrol:
    image: ${DOCKER_REGISTRY-}mcpserverflightcontrol
    build:
      context: .
      dockerfile: McpServer.FlightControl/Dockerfile
    environment:
      - BffServiceUrl=http://bff.service:8080
      - C4IServiceUrl=http://c4ientities:8080
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://aspire-dashboard:4317
      - OTEL_SERVICE_NAME=flight-mcp-flightcontrol

  mcpserver.missioncontrol:
    image: ${DOCKER_REGISTRY-}mcpservermissioncontrol
    build:
      context: .
      dockerfile: McpServer.MissionControl/Dockerfile
    environment:
      - C4IServiceUrl=http://c4ientities:8080
      - BffServiceUrl=http://bff.service:8080
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://aspire-dashboard:4317
      - OTEL_SERVICE_NAME=flight-mcp-missioncontrol

volumes:
  postgres_data:
